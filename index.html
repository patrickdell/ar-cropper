<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Cropper</title>
  <!-- Cropper.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" integrity="sha512-uZx0p9W+wq1l2oz5c5lEwK3m2k8h0tVj8n7l4r7QA0jGxK3Jw2uH0w2lqW8d1Gk2mCE4r0eK2FhKkC6wZg3VUg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js" integrity="sha512-GFQ1l3pZK0q1H8O3p9p2H4n1n6j5Y0hNnX2s6gE0m3rUqzQH6F5m2p0x2m/9m0Q7n9F8hX3x8YF9JwY8o3fWew==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- EXIF reader (for tiny metadata chip) -->
  <script src="https://cdn.jsdelivr.net/npm/exifreader@4.23.4/dist/exif-reader.min.js"></script>
  <style>
    :root { --bg:#0c0c0f; --panel:#15151a; --ink:#eaeaf0; --muted:#9aa0a6; --accent:#8ab4f8; }
    html,body{height:100%;}
    body{margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--ink);}
    .wrap{display:grid; grid-template-columns: 1fr 320px; gap:16px; height:100vh; padding:16px; box-sizing:border-box;}
    .panel{background:var(--panel); border:1px solid #23232a; border-radius:12px; padding:12px;}
    h1{font-size:18px; margin:0 0 8px 0;}
    p.help{margin:6px 0 12px 0; color:var(--muted);}    
    .stage{position:relative; height:calc(100% - 8px); background:#0a0a0d; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; border:1px dashed #2b2b33;}
    .stage.drag{outline:2px dashed var(--accent); outline-offset:-6px; background:rgba(138,180,248,0.08);}    
    img#preview{max-width:100%; max-height:100%; display:block;}
    .meta-chip{position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:6px 8px; border-radius:999px; font-size:12px; display:flex; gap:8px; align-items:center; backdrop-filter: blur(4px);}
    .meta-chip span{white-space:nowrap; opacity:0.9;}
    .controls{display:grid; gap:12px;}
    .row{display:grid; gap:8px;}
    label{font-weight:600;}
    select, input[type="range"], button, .btn{background:#1c1c23; color:var(--ink); border:1px solid #2a2a33; padding:8px 10px; border-radius:8px; font-size:14px;}
    button, .btn{cursor:pointer;}
    .btn-row{display:flex; gap:8px; flex-wrap:wrap;}
    .muted{color:var(--muted);}    
    .file-zone{display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .file-zone input[type="file"]{flex:1;}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#111; border:1px solid #333; padding:1px 6px; border-radius:6px; font-size:12px;}
    .footer{font-size:12px; color:var(--muted);}    
  </style>
</head>
<body>
  <div class="wrap">
    <section class="panel" style="min-width:0;">
      <h1>AR Cropper</h1>
      <p class="help">Upload or drag and drop an image on the preview area, choose an aspect ratio, pan the crop by dragging or arrow keys and zoom with mouse wheel or slider. Preview, then download the cropped JPEG. <strong>No resizing/scaling of output.</strong></p>
      <div id="stage" class="stage" aria-label="Image preview and drop area" tabindex="0">
        <img id="preview" alt="Upload to start" />
        <div id="metaChip" class="meta-chip" hidden>
          <span id="metaDims">—</span>
          <span id="metaCam" class="muted">—</span>
          <span id="metaDate" class="muted">—</span>
        </div>
      </div>
    </section>

    <aside class="panel controls">
      <div class="row">
        <label for="file">Image</label>
        <div class="file-zone">
          <input type="file" id="file" accept="image/*" />
          <button id="clear" title="Clear image">Clear</button>
        </div>
        <small class="muted">Tip: You can also drag & drop onto the preview.</small>
      </div>

      <div class="row">
        <label for="ratio">Aspect ratio</label>
        <select id="ratio">
          <option value="NaN">Free</option>
          <option value="1">1:1</option>
          <option value="4/5">4:5</option>
          <option value="3/2">3:2</option>
          <option value="2/3">2:3</option>
          <option value="4/3">4:3</option>
          <option value="5/4">5:4</option>
          <option value="7/5">7:5</option>
          <!-- New presets added at the bottom as requested -->
          <option value="16/9">16:9 - video</option>
          <option value="9/16">9:16 - video</option>
        </select>
      </div>

      <div class="row">
        <label for="zoom">Zoom</label>
        <input id="zoom" type="range" min="-5" max="5" step="0.01" value="0" />
        <small class="muted">Mouse wheel over the image also zooms.</small>
      </div>

      <div class="row">
        <label>Pan</label>
        <div class="btn-row">
          <button data-move="-10,0" title="Left">◀︎</button>
          <button data-move="10,0" title="Right">▶︎</button>
          <button data-move="0,-10" title="Up">▲</button>
          <button data-move="0,10" title="Down">▼</button>
          <span class="muted">or use arrow keys <span class="kbd">← → ↑ ↓</span></span>
        </div>
      </div>

      <div class="row">
        <label>Preview & export</label>
        <div class="btn-row">
          <button id="fit">Fit</button>
          <button id="reset">Reset</button>
          <button id="download">Download JPEG</button>
        </div>
        <small class="muted">Exports the exact cropped region—no scaling.</small>
      </div>

      <div class="footer">Keys: <span class="kbd">0</span> reset zoom, <span class="kbd">F</span> fit, <span class="kbd">R</span> reset.</div>
    </aside>
  </div>

  <script>
    const img = document.getElementById('preview');
    const stage = document.getElementById('stage');
    const fileInput = document.getElementById('file');
    const ratioSel = document.getElementById('ratio');
    const zoomSlider = document.getElementById('zoom');
    const btnReset = document.getElementById('reset');
    const btnFit = document.getElementById('fit');
    const btnDownload = document.getElementById('download');
    const btnClear = document.getElementById('clear');

    const metaChip = document.getElementById('metaChip');
    const metaDims = document.getElementById('metaDims');
    const metaCam = document.getElementById('metaCam');
    const metaDate = document.getElementById('metaDate');

    let cropper = null;
    let wheelDelta = 0; // for smooth wheel->zoom slider sync

    function initCropper() {
      if (cropper) cropper.destroy();
      cropper = new Cropper(img, {
        viewMode: 1,
        dragMode: 'move',
        autoCrop: true,
        autoCropArea: 0.9,
        responsive: true,
        zoomOnTouch: false,
        wheelZoomRatio: 0.1,
        checkOrientation: true,
        ready() {
          // Apply selected ratio immediately
          const v = ratioSel.value;
          cropper.setAspectRatio(isNaN(Number(v)) ? NaN : eval(v));
          updateMetaDims();
        },
        crop() {
          updateMetaDims();
        }
      });
    }

    function updateMetaDims() {
      if (!cropper) return;
      const data = cropper.getImageData();
      if (!data.naturalWidth) return;
      const crop = cropper.getData();
      const w = Math.round(crop.width);
      const h = Math.round(crop.height);
      metaDims.textContent = `${w}×${h}px`;
      metaChip.hidden = false;
    }

    function loadFile(file) {
      if (!file) return;
      const url = URL.createObjectURL(file);
      img.onload = () => {
        URL.revokeObjectURL(url);
        initCropper();
        // Parse EXIF for tiny chip
        try {
          file.arrayBuffer().then((buf) => {
            const tags = ExifReader.load(buf, { expanded: true });
            const make = tags.Make?.description || '';
            const model = tags.Model?.description || '';
            metaCam.textContent = [make, model].filter(Boolean).join(' ').trim() || '—';
            const dt = tags.DateTimeOriginal?.description || tags.CreateDate?.description || '';
            metaDate.textContent = dt || '—';
          }).catch(()=>{});
        } catch(e) {}
      };
      img.src = url;
    }

    fileInput.addEventListener('change', (e) => {
      loadFile(e.target.files?.[0]);
    });

    // Drag & drop onto stage
    ;['dragenter','dragover'].forEach(evt => stage.addEventListener(evt, (e)=>{
      e.preventDefault(); e.stopPropagation(); stage.classList.add('drag');
    }));
    ;['dragleave','drop'].forEach(evt => stage.addEventListener(evt, (e)=>{
      e.preventDefault(); e.stopPropagation(); stage.classList.remove('drag');
    }));
    stage.addEventListener('drop', (e)=>{
      const file = e.dataTransfer?.files?.[0];
      if (file) loadFile(file);
    });

    // Aspect ratio change
    ratioSel.addEventListener('change', () => {
      if (!cropper) return;
      const v = ratioSel.value;
      const ratio = isNaN(Number(v)) ? NaN : eval(v);
      cropper.setAspectRatio(ratio);
    });

    // Zoom slider: map [-5..5] to cropper zoom levels (~exp curve)
    function sliderToZoom(val) {
      // Convert linear slider to exponential zoom factor; base 1.2
      return Math.pow(1.2, Number(val));
    }
    function syncZoomFromSlider() {
      if (!cropper) return;
      const factor = sliderToZoom(zoomSlider.value);
      const current = cropper.getImageData().scaleX || 1;
      const delta = factor / current;
      if (!isFinite(delta) || delta === 1) return;
      cropper.zoomTo(factor);
    }
    zoomSlider.addEventListener('input', syncZoomFromSlider);

    // Mouse wheel -> zoom
    stage.addEventListener('wheel', (e)=>{
      if (!cropper) return;
      e.preventDefault();
      const dir = e.deltaY < 0 ? 1 : -1; // natural: up = zoom in
      wheelDelta += dir * 0.15;
      wheelDelta = Math.max(-5, Math.min(5, wheelDelta));
      zoomSlider.value = String(wheelDelta);
      syncZoomFromSlider();
    }, { passive:false });

    // Pan buttons
    document.querySelectorAll('[data-move]').forEach(btn => {
      btn.addEventListener('click', ()=>{
        if (!cropper) return;
        const [x,y] = btn.getAttribute('data-move').split(',').map(Number);
        cropper.move(x,y);
      });
    });

    // Keyboard: arrows pan, R reset, F fit, 0 reset zoom
    window.addEventListener('keydown', (e) => {
      if (!cropper) return;
      const step = e.shiftKey ? 20 : 10;
      switch(e.key) {
        case 'ArrowLeft': cropper.move(-step,0); e.preventDefault(); break;
        case 'ArrowRight': cropper.move(step,0); e.preventDefault(); break;
        case 'ArrowUp': cropper.move(0,-step); e.preventDefault(); break;
        case 'ArrowDown': cropper.move(0,step); e.preventDefault(); break;
        case 'r': case 'R': cropper.reset(); zoomSlider.value = '0'; wheelDelta = 0; e.preventDefault(); break;
        case 'f': case 'F': cropper.reset(); cropper.zoomTo(1); zoomSlider.value = '0'; wheelDelta = 0; e.preventDefault(); break;
        case '0': zoomSlider.value = '0'; wheelDelta = 0; cropper.zoomTo(1); e.preventDefault(); break;
      }
    });

    // Fit & Reset buttons
    btnReset.addEventListener('click', ()=>{ if (!cropper) return; cropper.reset(); zoomSlider.value='0'; wheelDelta=0; });
    btnFit.addEventListener('click', ()=>{ if (!cropper) return; cropper.reset(); cropper.zoomTo(1); zoomSlider.value='0'; wheelDelta=0; });

    // Download: export exact crop region (no scaling)
    btnDownload.addEventListener('click', () => {
      if (!cropper) return;
      const canvas = cropper.getCroppedCanvas({ imageSmoothingEnabled: false, imageSmoothingQuality: 'low' });
      canvas.toBlob((blob)=>{
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'crop.jpg';
        a.click();
        URL.revokeObjectURL(a.href);
      }, 'image/jpeg', 0.92);
    });

    // Clear image
    btnClear.addEventListener('click', ()=>{
      if (cropper) { cropper.destroy(); cropper = null; }
      img.removeAttribute('src');
      metaChip.hidden = true;
      fileInput.value = '';
      zoomSlider.value = '0';
      wheelDelta = 0;
    });
  </script>
</body>
</html>
