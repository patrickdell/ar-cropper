<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickCrop</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
      background: #f8f8f8;
    }
    h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }
    p {
      margin: 10px 0 20px;
      color: #333;
    }
    #uploadArea {
      border: 2px dashed #aaa;
      padding: 20px;
      margin: 20px auto;
      background: #fff;
      width: 80%;
      max-width: 800px;
      cursor: pointer;
      position: relative;
    }
    #uploadArea.dragover {
      border-color: #333;
      background: #f0f0f0;
    }
    canvas {
      max-width: 100%;
      border: 1px solid #ccc;
      margin-top: 20px;
      cursor: grab;
    }
    .buttons {
      margin: 20px 0;
    }
    .buttons button {
      margin: 5px;
      padding: 8px 14px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: #fff;
      font-size: 14px;
    }
    .buttons button:hover {
      background: #0056b3;
    }
    #preview {
      margin-top: 20px;
      max-width: 80%;
      border: 1px solid #ddd;
      display: none;
    }
    #slider {
      width: 200px;
      margin-top: 15px;
    }
    #metadataBadge {
      display: inline-block;
      background: #eee;
      padding: 5px 10px;
      border-radius: 12px;
      font-size: 12px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>QuickCrop</h1>
  <p>
    Upload or drag and drop an image on the preview area, choose an aspect ratio, 
    pan the crop by dragging or arrow keys and zoom with mouse wheel or slider. 
    Preview, then download the cropped JPEG. No resizing/scaling of output.
  </p>

  <div id="uploadArea">
    <input type="file" id="upload" accept="image/*" style="display:none">
    <p>Click or drag an image here to upload</p>
  </div>

  <canvas id="canvas"></canvas>

  <div class="buttons" id="ratioButtons">
    <button data-ratio="3/2">3:2</button>
    <button data-ratio="4/3">4:3</button>
    <button data-ratio="1/1">1:1</button>
    <button data-ratio="4/5">4:5</button>
    <button data-ratio="2/3">2:3</button>
    <button data-ratio="16/9">16:9 - video</button>
    <button data-ratio="9/16">9:16 - video</button>
  </div>

  <div class="buttons">
    <button id="previewBtn">Preview</button>
    <button id="downloadBtn">Download</button>
    <button id="undoBtn">Undo</button>
    <button id="resetBtn">Start Over</button>
  </div>

  <input type="range" id="slider" min="1" max="3" step="0.01" value="1">
  <div id="metadataBadge">No image loaded</div>

  <img id="preview" alt="Preview">

  <script src="https://cdn.jsdelivr.net/npm/piexifjs"></script>
  <script>
    const uploadArea = document.getElementById('uploadArea');
    const uploadInput = document.getElementById('upload');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const slider = document.getElementById('slider');
    const previewImg = document.getElementById('preview');
    const metadataBadge = document.getElementById('metadataBadge');

    let img = new Image();
    let exifData = null;
    let crop = {x: 0, y: 0, scale: 1, ratio: 1};
    let dragging = false;
    let startX, startY;

    function loadImage(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const dataURL = e.target.result;
        const exif = piexif.load(dataURL);
        exifData = exif;
        updateMetadataBadge(exif);

        img.onload = function() {
          canvas.width = img.width;
          canvas.height = img.height;
          crop.x = 0;
          crop.y = 0;
          crop.scale = 1;
          drawCrop();
        };
        img.src = dataURL;
      };
      reader.readAsDataURL(file);
    }

    function updateMetadataBadge(exif) {
      const make = exif['0th'][piexif.ImageIFD.Make] || 'Unknown';
      const model = exif['0th'][piexif.ImageIFD.Model] || '';
      metadataBadge.textContent = `Metadata: ${make} ${model}`;
    }

    function drawCrop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const cropWidth = canvas.width / crop.scale;
      const cropHeight = cropWidth / crop.ratio;
      ctx.drawImage(img, crop.x, crop.y, cropWidth, cropHeight, 0, 0, canvas.width, canvas.height);
    }

    document.getElementById('ratioButtons').addEventListener('click', e => {
      if (e.target.tagName === 'BUTTON') {
        crop.ratio = eval(e.target.getAttribute('data-ratio'));
        drawCrop();
      }
    });

    slider.addEventListener('input', () => {
      crop.scale = slider.value;
      drawCrop();
    });

    canvas.addEventListener('mousedown', e => {
      dragging = true;
      startX = e.offsetX;
      startY = e.offsetY;
    });

    canvas.addEventListener('mousemove', e => {
      if (dragging) {
        crop.x -= (e.offsetX - startX) / crop.scale;
        crop.y -= (e.offsetY - startY) / crop.scale;
        startX = e.offsetX;
        startY = e.offsetY;
        drawCrop();
      }
    });

    canvas.addEventListener('mouseup', () => dragging = false);

    document.getElementById('previewBtn').addEventListener('click', () => {
      previewImg.src = canvas.toDataURL('image/jpeg');
      previewImg.style.display = 'block';
    });

    document.getElementById('downloadBtn').addEventListener('click', () => {
      let jpeg = canvas.toDataURL('image/jpeg');
      if (exifData) {
        const exifStr = piexif.dump(exifData);
        jpeg = piexif.insert(exifStr, jpeg);
      }
      const link = document.createElement('a');
      link.download = 'crop.jpg';
      link.href = jpeg;
      link.click();
    });

    document.getElementById('undoBtn').addEventListener('click', () => {
      crop.scale = 1;
      crop.x = 0;
      crop.y = 0;
      drawCrop();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      location.reload();
    });

    // Upload via click
    uploadArea.addEventListener('click', () => uploadInput.click());
    uploadInput.addEventListener('change', e => loadImage(e.target.files[0]));

    // Drag and drop
    uploadArea.addEventListener('dragover', e => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', e => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) loadImage(file);
    });
  </script>
</body>
</html>
